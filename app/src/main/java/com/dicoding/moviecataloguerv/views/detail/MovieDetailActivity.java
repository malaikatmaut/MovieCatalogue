package com.dicoding.moviecataloguerv.views.detail;import android.content.Intent;import android.net.Uri;import android.os.Bundle;import android.view.Menu;import android.view.MenuItem;import android.view.View;import android.widget.ImageView;import android.widget.TextView;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.appcompat.app.AppCompatActivity;import androidx.lifecycle.ViewModelProvider;import androidx.navigation.ActivityNavigator;import androidx.recyclerview.widget.LinearLayoutManager;import com.bumptech.glide.Glide;import com.bumptech.glide.request.RequestOptions;import com.dicoding.moviecataloguerv.BuildConfig;import com.dicoding.moviecataloguerv.R;import com.dicoding.moviecataloguerv.adapter.BackdropSlideAdapter;import com.dicoding.moviecataloguerv.adapter.CastAdapter;import com.dicoding.moviecataloguerv.adapter.SimilarAdapter;import com.dicoding.moviecataloguerv.data.source.model.Cast;import com.dicoding.moviecataloguerv.data.source.model.ImageItems;import com.dicoding.moviecataloguerv.data.source.model.Movie;import com.dicoding.moviecataloguerv.data.source.model.Similar;import com.dicoding.moviecataloguerv.data.source.model.Video;import com.dicoding.moviecataloguerv.data.source.remote.response.VideosResponse;import com.dicoding.moviecataloguerv.databinding.ActivityMovieDetailBinding;import com.dicoding.moviecataloguerv.utils.BaseAppCompatActivity;import com.dicoding.moviecataloguerv.utils.StringUtils;import com.dicoding.moviecataloguerv.viewmodel.MovieDetailViewModel;import com.dicoding.moviecataloguerv.viewmodel.ViewModelFactory;import com.dicoding.moviecataloguerv.widget.FavoriteMovieWidget;import com.google.android.material.appbar.AppBarLayout;import com.google.android.material.snackbar.Snackbar;import com.smarteist.autoimageslider.SliderAnimations;import java.util.ArrayList;import java.util.List;import java.util.Locale;import java.util.Objects;import static com.bumptech.glide.load.resource.drawable.DrawableTransitionOptions.withCrossFade;import static com.dicoding.moviecataloguerv.BuildConfig.YOUTUBE_VIDEO_URL;public class MovieDetailActivity extends BaseAppCompatActivity {    private ActivityMovieDetailBinding binding;    private MovieDetailViewModel viewModel;    public static final String MOVIE_ID = "movie_id";    private int movieId;    private Movie movie;    private boolean favorite;    private String msg;    private CastAdapter castAdapter;    private SimilarAdapter similarAdapter;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        binding = ActivityMovieDetailBinding.inflate(getLayoutInflater());        setContentView(binding.getRoot());        movieId = MovieDetailActivityArgs.fromBundle(Objects.requireNonNull(getIntent().getExtras())).getMovieId();        showLoading(true);        setupToolbar();        binding.castRv.setLayoutManager(new LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false));        castAdapter = new CastAdapter(new ArrayList<>());        binding.castRv.setAdapter(castAdapter);        binding.similarRv.setLayoutManager(new LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false));        similarAdapter = new SimilarAdapter(new ArrayList<>(), "movie", onItemClicked);        binding.similarRv.setAdapter(similarAdapter);        viewModel = obtainViewModel(this);        observeData();    }    @Override    public boolean onCreateOptionsMenu(Menu menu) {        getMenuInflater().inflate(R.menu.details_menu, menu);        super.onCreateOptionsMenu(menu);        return true;    }    @Override    public boolean onPrepareOptionsMenu(Menu menu) {        if (favorite) {            menu.findItem(R.id.favorite).setIcon(R.drawable.ic_favorite);        } else {            menu.findItem(R.id.favorite).setIcon(R.drawable.ic_favorite_border);        }        super.onPrepareOptionsMenu(menu);        return true;    }    @Override    public boolean onOptionsItemSelected(@NonNull MenuItem item) {        if (item.getItemId() == R.id.favorite) {            if (viewModel.getFavMovie(movieId) == null) {                addFavorite(item);            } else {                deleteFavorite(item);            }        }        return super.onOptionsItemSelected(item);    }    @Override    public boolean onSupportNavigateUp() {        onBackPressed();        return true;    }    private void setupToolbar() {        setSupportActionBar(binding.toolbarDetail);        if (getSupportActionBar() != null) {            getSupportActionBar().setDisplayHomeAsUpEnabled(true);            getSupportActionBar().setHomeAsUpIndicator(R.drawable.ic_back_dark);        }        binding.appBar.addOnOffsetChangedListener(new AppBarLayout.OnOffsetChangedListener() {            boolean isShow = true;            int scrollRange = -1;            @Override            public void onOffsetChanged(AppBarLayout appBarLayout, int verticalOffset) {                if (scrollRange == -1) {                    scrollRange = appBarLayout.getTotalScrollRange();                }                if (scrollRange + verticalOffset == 0) {                    binding.collapsingToolbar.setTitle(movie.getTitle());                    binding.cardBanner.setVisibility(View.GONE);                    isShow = true;                } else if (isShow) {                    binding.collapsingToolbar.setTitle(" ");                    binding.cardBanner.setVisibility(View.VISIBLE);                    isShow = false;                }            }        });    }    @NonNull    private static MovieDetailViewModel obtainViewModel(AppCompatActivity activity) {        ViewModelFactory factory = ViewModelFactory.getInstance(activity.getApplication());        return new ViewModelProvider(activity, factory).get(MovieDetailViewModel.class);    }    private void observeData() {        viewModel.getMovieDetail(movieId).observe(this, movieDetail -> {            if (movieDetail != null) {                setMovieDetails(movieDetail);                setBackdropsSlider(movieDetail.getImages().getBackdrops());                setMovieVideos(movieDetail.getVideos());                setCastList(movieDetail.getCredits().getCast());                setSimilarList(movieDetail.getSimilar().getSimilar());                if (viewModel.getFavMovie(movieId) != null) {                    favorite = true;                    invalidateOptionsMenu();                }                showLoading(false);            }        });    }    private void setMovieDetails(Movie movie) {        this.movie = movie;        if (this.movie == null) {            showError();        } else {            binding.movieDetailsTitle.setText(this.movie.getTitle());            binding.movieDetailsOverview.setText(this.movie.getOverview());            binding.ratingText.setText(String.valueOf(this.movie.getRating()));            binding.ratingCount.setText(String.format(Locale.US, "%,d", this.movie.getRatingVotes()));            binding.movieDetailsDuration.setText(StringUtils.getRuntime(this.movie.getDuration()));            binding.movieDetailsGenres.setText(StringUtils.getGenres(this.movie.getGenres()));            binding.movieDetailsReleaseDate.setText(StringUtils.getReleaseDate(this.movie.getReleaseDate()));            Glide.with(this)                    .load(BuildConfig.TMDB_IMAGE_342 + this.movie.getPosterPath())                    .error(R.drawable.ic_undraw_404)                    .apply(RequestOptions.placeholderOf(R.drawable.ic_undraw_images).centerCrop())                    .transition(withCrossFade())                    .into(binding.movieDetailsPoster);        }    }    private void setBackdropsSlider(List<ImageItems> imageItems) {        binding.imageSlider.setSliderAdapter(new BackdropSlideAdapter(imageItems));        binding.imageSlider.setSliderTransformAnimation(SliderAnimations.FADETRANSFORMATION);        binding.imageSlider.setIndicatorVisibility(false);    }    private void setMovieVideos(VideosResponse videosResponse) {        binding.movieTrailers.removeAllViews();        if (videosResponse != null) {            if (videosResponse.getVideos().size() == 0) {                binding.trailersLabel.setVisibility(View.GONE);                binding.movieTrailers.setVisibility(View.GONE);            } else {                for (final Video video : videosResponse.getVideos()) {                    View parent = getLayoutInflater().inflate(R.layout.item_trailer, binding.movieTrailers, false);                    ImageView thumbnailTrailer = parent.findViewById(R.id.thumbnail_trailer);                    TextView movieTrailerTitle = parent.findViewById(R.id.trailerTitle);                    movieTrailerTitle.setText(video.getName());                    Glide.with(this)                            .load(String.format(BuildConfig.YOUTUBE_THUMBNAIL_URL, video.getKey()))                            .apply(RequestOptions.placeholderOf(R.color.colorPrimary).centerCrop())                            .into(thumbnailTrailer);                    thumbnailTrailer.requestLayout();                    thumbnailTrailer.setOnClickListener(v -> startActivity(                            new Intent(Intent.ACTION_VIEW, Uri.parse(String.format(YOUTUBE_VIDEO_URL, video.getKey())))                    ));                    binding.movieTrailers.addView(parent);                }            }        } else {            showError();            binding.trailersLabel.setVisibility(View.GONE);            binding.movieTrailers.setVisibility(View.GONE);        }    }    private void setCastList(List<Cast> castList) {        if (castList.size() != 0) {            castAdapter.setCastList(castList);        } else {            binding.castLabel.setVisibility(View.GONE);            binding.castRv.setVisibility(View.GONE);        }    }    private void setSimilarList(List<Similar> similarList) {        if (similarList.size() != 0) {            similarAdapter.setSimilarList(similarList);        } else {            binding.similarLabel.setVisibility(View.GONE);            binding.similarRv.setVisibility(View.GONE);        }    }    private SimilarAdapter.OnItemClicked onItemClicked = id -> {        ActivityNavigator activityNavigator = new ActivityNavigator(this);        Intent intent = new Intent(this, MovieDetailActivity.class);        intent.putExtra(MovieDetailActivity.MOVIE_ID, id);        activityNavigator.navigate(activityNavigator.createDestination().setIntent(intent), null, null, null);    };    private void showLoading(Boolean state) {        if (state) {            binding.backgroundLoading.setVisibility(View.VISIBLE);            binding.progressBar.setVisibility(View.VISIBLE);            binding.appBar.setVisibility(View.GONE);            binding.constraint.setVisibility(View.GONE);        } else {            binding.backgroundLoading.setVisibility(View.GONE);            binding.progressBar.setVisibility(View.GONE);            binding.appBar.setVisibility(View.VISIBLE);            binding.constraint.setVisibility(View.VISIBLE);        }    }    private void showError() {        Toast.makeText(this, "Check your internet connection.", Toast.LENGTH_SHORT).show();    }    private void addFavorite(final MenuItem item) {        viewModel.insertFavMovie(movie);        favorite = true;        item.setIcon(R.drawable.ic_favorite);        msg = movie.getTitle() + " " + getString(R.string.add_favorite_movie);        Snackbar snackbar = Snackbar                .make(binding.getRoot(), msg, Snackbar.LENGTH_LONG)                .setAction(R.string.undo, view -> {                    deleteFavorite(item);                    msg = movie.getTitle() + " " + getString(R.string.delete_favorite_movie);                    Snackbar snackbarUndo = Snackbar.make(binding.getRoot(), msg, Snackbar.LENGTH_LONG)                            .setTextColor(getResources().getColor(R.color.colorPrimary))                            .setBackgroundTint(getResources().getColor(R.color.colorWhite))                            .setActionTextColor(getResources().getColor(R.color.colorPrimaryLight));                    snackbarUndo.show();                })                .setTextColor(getResources().getColor(R.color.colorPrimary))                .setBackgroundTint(getResources().getColor(R.color.colorWhite))                .setActionTextColor(getResources().getColor(R.color.colorAccent));        snackbar.show();        FavoriteMovieWidget.updateWidget(this);    }    private void deleteFavorite(final MenuItem item) {        viewModel.deleteFavMovie(movie);        favorite = false;        item.setIcon(R.drawable.ic_favorite_border);        msg = movie.getTitle() + " " + getString(R.string.delete_favorite_movie);        Snackbar snackbar = Snackbar.make(binding.getRoot(), msg, Snackbar.LENGTH_LONG)                .setAction(R.string.undo, view -> {                    addFavorite(item);                    msg = movie.getTitle() + " " + getString(R.string.add_favorite_movie);                    Snackbar snackbarUndo = Snackbar.make(binding.getRoot(), msg, Snackbar.LENGTH_LONG)                            .setTextColor(getResources().getColor(R.color.colorPrimary))                            .setBackgroundTint(getResources().getColor(R.color.colorWhite))                            .setActionTextColor(getResources().getColor(R.color.colorPrimaryLight));                    snackbarUndo.show();                })                .setTextColor(getResources().getColor(R.color.colorPrimary))                .setBackgroundTint(getResources().getColor(R.color.colorWhite))                .setActionTextColor(getResources().getColor(R.color.colorPrimaryLight));        snackbar.show();        FavoriteMovieWidget.updateWidget(this);    }}