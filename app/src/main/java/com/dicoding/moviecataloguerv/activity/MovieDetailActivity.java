package com.dicoding.moviecataloguerv.activity;import android.content.ContentValues;import android.content.Intent;import android.net.Uri;import android.os.Bundle;import android.text.TextUtils;import android.util.Log;import android.view.Menu;import android.view.MenuItem;import android.view.View;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.ProgressBar;import android.widget.RatingBar;import android.widget.TextView;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.appcompat.app.AppCompatActivity;import androidx.appcompat.widget.Toolbar;import androidx.constraintlayout.widget.ConstraintLayout;import androidx.coordinatorlayout.widget.CoordinatorLayout;import androidx.lifecycle.Observer;import androidx.lifecycle.ViewModelProvider;import com.bumptech.glide.Glide;import com.bumptech.glide.request.RequestOptions;import com.dicoding.moviecataloguerv.BuildConfig;import com.dicoding.moviecataloguerv.R;import com.dicoding.moviecataloguerv.contentprovider.MovieFavorite;import com.dicoding.moviecataloguerv.model.Cast;import com.dicoding.moviecataloguerv.model.CreditsResponse;import com.dicoding.moviecataloguerv.model.Genre;import com.dicoding.moviecataloguerv.model.GenresResponse;import com.dicoding.moviecataloguerv.model.Movie;import com.dicoding.moviecataloguerv.model.Similar;import com.dicoding.moviecataloguerv.model.SimilarResponse;import com.dicoding.moviecataloguerv.model.Trailer;import com.dicoding.moviecataloguerv.model.TrailerResponse;import com.dicoding.moviecataloguerv.viewmodel.FavoritesViewModel;import com.dicoding.moviecataloguerv.viewmodel.MoviesViewModel;import com.dicoding.moviecataloguerv.widget.FavoriteMovieWidget;import com.google.android.material.appbar.AppBarLayout;import com.google.android.material.appbar.CollapsingToolbarLayout;import com.google.android.material.snackbar.Snackbar;import java.text.ParseException;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Date;import java.util.Locale;import static com.dicoding.moviecataloguerv.BuildConfig.YOUTUBE_VIDEO_URL;import static com.dicoding.moviecataloguerv.contentprovider.DatabaseContract.FavoriteMovieColumns.BACKDROP;import static com.dicoding.moviecataloguerv.contentprovider.DatabaseContract.FavoriteMovieColumns.CONTENT_URI;import static com.dicoding.moviecataloguerv.contentprovider.DatabaseContract.FavoriteMovieColumns.POSTER_PATH;import static com.dicoding.moviecataloguerv.contentprovider.DatabaseContract.FavoriteMovieColumns.RELEASE_DATE;import static com.dicoding.moviecataloguerv.contentprovider.DatabaseContract.FavoriteMovieColumns.TITLE;import static com.dicoding.moviecataloguerv.contentprovider.DatabaseContract.FavoriteMovieColumns.VOTE_AVERAGE;import static com.dicoding.moviecataloguerv.contentprovider.DatabaseContract.FavoriteMovieColumns._ID;public class MovieDetailActivity extends AppCompatActivity {    public static String MOVIE_ID = "movie_id";    private MoviesViewModel moviesViewModel;    private FavoritesViewModel favoritesViewModel;    private ImageView moviePoster;    private ImageView movieBackdrop;    private TextView movieTitle;    private TextView movieGenres;    private TextView movieOverview;    private TextView movieReleaseDate;    private RatingBar movieRating;    private LinearLayout movieTrailers;    private LinearLayout movieCasts;    private LinearLayout movieSimilar;    private ProgressBar progressBar;    private ImageView backgroundLoading;    private AppBarLayout appBarLayout;    private ConstraintLayout constraintLayout;    private TextView movieTrailerLabel;    private TextView movieCastLabel;    private TextView movieSimilarLabel;    private TextView ratingText;    private TextView ratingVotes;    private TextView movieDuration;    private CoordinatorLayout coordinatorLayout;    private String language;    private int movieId;    private Movie movie;    private boolean favorite;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_movie_detail);        language = getResources().getString(R.string.language);        setupToolbar();        initUI();        showLoading(true);        movieId = getIntent().getIntExtra(MOVIE_ID, movieId);        Log.d(getLocalClassName(), String.valueOf(movieId));        moviesViewModel = new ViewModelProvider(this, new ViewModelProvider.NewInstanceFactory()).get(MoviesViewModel.class);        favoritesViewModel = new ViewModelProvider(this, new ViewModelProvider.AndroidViewModelFactory(this.getApplication())).get(FavoritesViewModel.class);        observeData();    }    private void observeData() {        moviesViewModel.getMovieItems(movieId, language).observe(this, new Observer<Movie>() {            @Override            public void onChanged(Movie items) {                if (items != null) {                    setMovie();                    if (favoritesViewModel.selectFavMovie(movieId) != null) {                        favorite = true;                        invalidateOptionsMenu();                    }                }            }        });        moviesViewModel.getGenres(language).observe(this, new Observer<GenresResponse>() {            @Override            public void onChanged(GenresResponse genresResponse) {                if (genresResponse != null) {                    setGenres();                }            }        });        moviesViewModel.getTrailers(movieId).observe(this, new Observer<TrailerResponse>() {            @Override            public void onChanged(TrailerResponse trailerResponse) {                if (trailerResponse != null) {                    setTrailers();                }            }        });        moviesViewModel.getCredits(movieId).observe(this, new Observer<CreditsResponse>() {            @Override            public void onChanged(CreditsResponse creditsResponse) {                if (creditsResponse != null) {                    setCasts();                }            }        });        moviesViewModel.getSimilar(movieId).observe(this, new Observer<SimilarResponse>() {            @Override            public void onChanged(SimilarResponse similarResponse) {                if (similarResponse != null) {                    setSimilar();                    showLoading(false);                }            }        });        Log.d("MovieDetail", "Loaded");    }    private void setupToolbar() {        Toolbar toolbar = findViewById(R.id.toolbar_detail);        setSupportActionBar(toolbar);        if (getSupportActionBar() != null) {            getSupportActionBar().setDisplayHomeAsUpEnabled(true);        }        final CollapsingToolbarLayout collapsingToolbar = findViewById(R.id.collapsingToolbar);        AppBarLayout appBarLayout = findViewById(R.id.app_bar);        appBarLayout.setElevation(5);        appBarLayout.addOnOffsetChangedListener(new AppBarLayout.OnOffsetChangedListener() {            boolean isShow = true;            int scrollRange = -1;            @Override            public void onOffsetChanged(AppBarLayout appBarLayout, int verticalOffset) {                if (scrollRange == -1) {                    scrollRange = appBarLayout.getTotalScrollRange();                }                if (scrollRange + verticalOffset == 0) {                    collapsingToolbar.setTitle(movie.getTitle());                    isShow = true;                } else if (isShow) {                    collapsingToolbar.setTitle(" ");                    isShow = false;                }            }        });    }    private void initUI() {        moviePoster = findViewById(R.id.movieDetailsPoster);        movieBackdrop = findViewById(R.id.movieDetailsBackdrop);        movieTitle = findViewById(R.id.movieDetailsTitle);        movieGenres = findViewById(R.id.movieDetailsGenres);        movieOverview = findViewById(R.id.movieDetailsOverview);        movieReleaseDate = findViewById(R.id.movieDetailsReleaseDate);        movieRating = findViewById(R.id.movieDetailsRating);        movieTrailers = findViewById(R.id.movieTrailers);        movieCasts = findViewById(R.id.movieCast);        movieSimilar = findViewById(R.id.movieSimilar);        progressBar = findViewById(R.id.progressBar);        backgroundLoading = findViewById(R.id.background_loading);        appBarLayout = findViewById(R.id.app_bar);        constraintLayout = findViewById(R.id.constraint);        movieTrailerLabel = findViewById(R.id.trailersLabel);        movieCastLabel = findViewById(R.id.castLabel);        movieSimilarLabel = findViewById(R.id.similarLabel);        ratingText = findViewById(R.id.rating_text);        ratingVotes = findViewById(R.id.rating_count);        coordinatorLayout = findViewById(R.id.coordinator_layout);        movieDuration = findViewById(R.id.movieDetailsDuration);    }    private void showLoading(Boolean state) {        if (state) {            backgroundLoading.setVisibility(View.VISIBLE);            progressBar.setVisibility(View.VISIBLE);            appBarLayout.setVisibility(View.GONE);            constraintLayout.setVisibility(View.GONE);        } else {            backgroundLoading.setVisibility(View.GONE);            progressBar.setVisibility(View.GONE);            appBarLayout.setVisibility(View.VISIBLE);            constraintLayout.setVisibility(View.VISIBLE);        }    }    private void setMovie() {        this.movie = moviesViewModel.getMovieItems(movieId, language).getValue();        if (movie == null) {            showError();        } else {            movieTitle.setText(movie.getTitle());            movieOverview.setText(movie.getOverview());            movieRating.setRating(movie.getRating() / 2);            ratingText.setText(String.valueOf(movie.getRating()));            ratingVotes.setText(String.format("(%s votes)", movie.getRatingVotes()));            setMovieReleaseDate(movie);            movieDuration.setText(String.format("%s minutes", movie.getDuration()));            if (movie.getGenres() != null) {                ArrayList<String> currentGenres = new ArrayList<>();                for (Genre genre : movie.getGenres()) {                    currentGenres.add(genre.getName());                }                movieGenres.setText(TextUtils.join(", ", currentGenres));            }            Glide.with(this)                    .load(BuildConfig.TMDB_IMAGE_BASE_URL + movie.getBackdrop())                    .error(R.drawable.ic_broken_image)                    .placeholder(R.drawable.ic_image)                    .apply(RequestOptions.placeholderOf(R.color.colorPrimaryDark))                    .into(movieBackdrop);            Glide.with(this)                    .load(BuildConfig.TMDB_IMAGE_342 + movie.getPosterPath())                    .error(R.drawable.ic_broken_image)                    .placeholder(R.drawable.ic_image)                    .apply(RequestOptions.placeholderOf(R.color.colorPrimaryDark))                    .into(moviePoster);        }    }    private void setMovieReleaseDate(Movie movie) {        String date = movie.getReleaseDate();        SimpleDateFormat input = new SimpleDateFormat("yyyy-MM-dd", Locale.US);        SimpleDateFormat output = new SimpleDateFormat("dd MMM yyyy", Locale.US);        try {            Date newDate = input.parse(date);            assert newDate != null;            movieReleaseDate.setText(output.format(newDate));        } catch (ParseException e) {            e.printStackTrace();        }    }    private void setGenres() {        GenresResponse genresResponse = moviesViewModel.getGenres(language).getValue();        if (genresResponse != null && genresResponse.getGenres() == null) {            showError();        }    }    private void setTrailers() {        TrailerResponse trailerResponse = moviesViewModel.getTrailers(movieId).getValue();        movieTrailers.removeAllViews();        if (trailerResponse != null) {            if (trailerResponse.getTrailers().size() == 0) {                movieTrailerLabel.setVisibility(View.GONE);                movieTrailers.setVisibility(View.GONE);            } else {                for (final Trailer trailer : trailerResponse.getTrailers()) {                    View parent = getLayoutInflater().inflate(R.layout.thumbnail_trailer, movieTrailers, false);                    ImageView thumbnailTrailer = parent.findViewById(R.id.thumbnail_trailer);                    TextView movieTrailerTitle = parent.findViewById(R.id.trailerTitle);                    movieTrailerTitle.setText(trailer.getName());                    Glide.with(this)                            .load(String.format(BuildConfig.YOUTUBE_THUMBNAIL_URL, trailer.getKey()))                            .apply(RequestOptions.placeholderOf(R.color.colorPrimary).centerCrop())                            .into(thumbnailTrailer);                    thumbnailTrailer.requestLayout();                    thumbnailTrailer.setOnClickListener(new View.OnClickListener() {                        @Override                        public void onClick(View v) {                            showTrailer(String.format(YOUTUBE_VIDEO_URL, trailer.getKey()));                        }                    });                    movieTrailers.addView(parent);                }            }        } else {            showError();            movieTrailerLabel.setVisibility(View.GONE);            movieTrailers.setVisibility(View.GONE);        }    }    private void setCasts() {        CreditsResponse creditsResponse = moviesViewModel.getCredits(movieId).getValue();        movieCasts.removeAllViews();        if (creditsResponse != null) {            if (creditsResponse.getCast().size() == 0) {                movieCastLabel.setVisibility(View.GONE);                movieCasts.setVisibility(View.GONE);            } else {                for (final Cast cast : creditsResponse.getCast()) {                    View parent = getLayoutInflater().inflate(R.layout.thumbnail_credits, movieCasts, false);                    ImageView thumbnailCast = parent.findViewById(R.id.thumbnail_cast);                    TextView castName = parent.findViewById(R.id.cast_name);                    TextView castCharacter = parent.findViewById(R.id.cast_character);                    castName.setText(cast.getName());                    castCharacter.setText(cast.getCharacter());                    Glide.with(MovieDetailActivity.this)                            .load(BuildConfig.TMDB_IMAGE_BASE_URL + cast.getProfilePath())                            .error(R.drawable.ic_action_user)                            .placeholder(R.drawable.ic_action_user)                            .into(thumbnailCast);                    thumbnailCast.requestLayout();                    movieCasts.addView(parent);                }            }        } else {            showError();            movieCastLabel.setVisibility(View.GONE);            movieCasts.setVisibility(View.GONE);        }    }    private void setSimilar() {        SimilarResponse similarResponse = moviesViewModel.getSimilar(movieId).getValue();        movieSimilar.removeAllViews();        if (similarResponse != null) {            if (similarResponse.getSimilar().size() == 0) {                movieSimilarLabel.setVisibility(View.GONE);                movieSimilar.setVisibility(View.GONE);            } else {                for (final Similar similar : similarResponse.getSimilar()) {                    View parent = getLayoutInflater().inflate(R.layout.thumbnail_similar, movieSimilar, false);                    ImageView thumbnailSimilar = parent.findViewById(R.id.thumbnail_similar);                    TextView movieSimilarTitle = parent.findViewById(R.id.similarMovieTitle);                    TextView movieSimilarRating = parent.findViewById(R.id.cv_movie_rating);                    movieSimilarTitle.setText(similar.getTitle());                    movieSimilarRating.setText(String.valueOf(similar.getRating()));                    Glide.with(this)                            .load(BuildConfig.TMDB_IMAGE_342 + similar.getPosterPath())                            .error(R.drawable.ic_broken_image)                            .placeholder(R.drawable.ic_image)                            .into(thumbnailSimilar);                    thumbnailSimilar.requestLayout();                    thumbnailSimilar.setOnClickListener(new View.OnClickListener() {                        @Override                        public void onClick(View v) {                            Intent intent = new Intent(MovieDetailActivity.this, MovieDetailActivity.class);                            intent.putExtra(MovieDetailActivity.MOVIE_ID, similar.getId());                            startActivity(intent);                        }                    });                    movieSimilar.addView(parent);                }            }        } else {            showError();            movieSimilarLabel.setVisibility(View.GONE);            movieSimilar.setVisibility(View.GONE);        }    }    private void showError() {        Toast.makeText(this, "Check your internet connection.", Toast.LENGTH_SHORT).show();    }    private void showTrailer(String url) {        Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));        startActivity(intent);    }    @Override    public boolean onSupportNavigateUp() {        onBackPressed();        return true;    }    @Override    public boolean onCreateOptionsMenu(Menu menu) {        getMenuInflater().inflate(R.menu.details_menu, menu);        super.onCreateOptionsMenu(menu);        return true;    }    @Override    public boolean onPrepareOptionsMenu(Menu menu) {        if (favorite) {            menu.findItem(R.id.favorite).setIcon(R.drawable.ic_favorite);        } else {            menu.findItem(R.id.favorite).setIcon(R.drawable.ic_favorite_border);        }        super.onPrepareOptionsMenu(menu);        return true;    }    @Override    public boolean onOptionsItemSelected(@NonNull MenuItem item) {        MovieFavorite movieFavorite = new MovieFavorite();        movieFavorite.setId(movie.getId());        movieFavorite.setTitle(movie.getTitle());        movieFavorite.setVoteAverage(movie.getRating());        movieFavorite.setReleaseDate(movie.getReleaseDate());        movieFavorite.setPosterPath(movie.getPosterPath());        movieFavorite.setBackdrop(movie.getBackdrop());        ContentValues values = new ContentValues();        values.put(_ID, movie.getId());        values.put(TITLE, movie.getTitle());        values.put(VOTE_AVERAGE, movie.getRating());        values.put(RELEASE_DATE, movie.getReleaseDate());        values.put(POSTER_PATH, movie.getPosterPath());        values.put(BACKDROP, movie.getBackdrop());        if (item.getItemId() == R.id.favorite) {            if (favoritesViewModel.selectFavMovie(movieId) == null) {                addFavorite(item, values);            } else {                deleteFavorite(item, values);            }        }        return super.onOptionsItemSelected(item);    }    private String msg;    private void addFavorite(final MenuItem item, final ContentValues values) {        favoritesViewModel.addFavoriteMovie(movie);        FavoriteMovieWidget.updateWidget(this);        getContentResolver().insert(CONTENT_URI, values);        favorite = true;        item.setIcon(R.drawable.ic_favorite);        msg = movie.getTitle() + " " + getString(R.string.add_favorite_movie);        Snackbar snackbar = Snackbar                .make(coordinatorLayout, msg, Snackbar.LENGTH_LONG)                .setAction(R.string.undo, new View.OnClickListener() {                    @Override                    public void onClick(View view) {                        deleteFavorite(item, values);                        msg = movie.getTitle() + " " + getString(R.string.delete_favorite_movie);                        Snackbar snackbarUndo = Snackbar.make(coordinatorLayout, msg, Snackbar.LENGTH_SHORT);                        snackbarUndo.show();                    }                });        snackbar.show();    }    private void deleteFavorite(final MenuItem item, final ContentValues values) {        favoritesViewModel.deleteFavMovie(movie);        FavoriteMovieWidget.updateWidget(this);        Uri uri = Uri.parse(CONTENT_URI + "/" + movie.getId());        getContentResolver().delete(uri, null, null);        favorite = false;        item.setIcon(R.drawable.ic_favorite_border);        msg = movie.getTitle() + " " + getString(R.string.delete_favorite_movie);        Snackbar snackbar = Snackbar                .make(coordinatorLayout, msg, Snackbar.LENGTH_LONG)                .setAction(R.string.undo, new View.OnClickListener() {                    @Override                    public void onClick(View view) {                        addFavorite(item, values);                        msg = movie.getTitle() + " " + getString(R.string.add_favorite_movie);                        Snackbar snackbarUndo = Snackbar.make(coordinatorLayout, msg, Snackbar.LENGTH_SHORT);                        snackbarUndo.show();                    }                });        snackbar.show();    }}